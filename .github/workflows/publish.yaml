name: Build and Publish Docker Image

on:
  push:
    branches:
      - main 
      - develop
      - feature/* 
      - bugfix/*  
      - release/* 
      - hotfix/*  
      - support/*  

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      packages: write 
    steps:
      - name: ‚¨áÔ∏è  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ü•Ç Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ./src/global.json 
      
      - name: üî¢  GitVersion install
        uses: gittools/actions/gitversion/setup@v3.2.0
        with:
          versionSpec: '6.1.x'
          preferLatestVersion: true
      
      - name: üî¢  Gitversion - Determine version
        id: version
        uses: gittools/actions/gitversion/execute@v3.2.0
        with:
          useConfigFile: true
          configFilePath: ${{ github.workspace }}/build/GitVersion.yaml
          updateProjectFiles: true
          
      - name: üë§  Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üöÄ Publish
        run: |
          BASE=ghcr.io/${{ github.repository_owner }}/jdc-build-erd
          TAG=${BASE}:${{ steps.version.outputs.semver }}
          docker build -t ${TAG} -f ./build/Dockerfile . --secret id=GITHUB_TOKEN,src=${{ secrets.GITHUB_TOKEN }}
          if [ "${{ github.ref_name }}" == "main" ]; then
            LATEST_TAG=${BASE}:latest
            docker tag ${TAG} ${LATEST_TAG}
          fi
          docker push ${TAG}
      
      - name: docker logout
        run: docker logout ghcr.io
